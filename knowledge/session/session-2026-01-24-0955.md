---
name: session-2026-01-24-0955
description: Planning and implementing modifier key support (Shift+Enter to create) with dynamic footer hints
keywords: modifier-keys, shift-enter, create-note, footer-instructions, fuzzy-suggest-modal, user-interaction
---

# Session: 2026-01-24 09:55

**Summary**: Planned and began implementation of modifier key support for SmartQuickSwitcherModal, matching Obsidian's original Quick Switcher behavior with Shift+Enter to create new notes and dynamic footer instruction hints.

## What Worked

- Knowledge migration to new format completed successfully (17 files with frontmatter)
- Comprehensive research via explore agent found exact Obsidian API methods:
  - `setInstructions()` for footer hints
  - `Keymap.isModifier()` and direct `evt.shiftKey` access
  - `app.vault.create()` for note creation
  - `app.fileManager.getNewFileParent()` for default folder
- Pure functions pattern applied to modifier key logic (testable, no Obsidian deps)
- User provided clear decisions on UX behavior

## What Failed

- N/A - Planning phase, no implementation attempts yet

## Design Decisions

Key architectural/design choices made this session:

| Decision | Options Considered | Chosen | Rationale |
|----------|-------------------|--------|-----------|
| Shift+Enter with selection | A) Always create (ignore selection)<br>B) Only create if no selection | B) Only create if no selection | More intuitive - Enter opens selected, Shift+Enter creates when nothing to open |
| Template setting scope | A) Global setting<br>B) Per-rule setting | A) Global setting | Simpler, user can change manually if needed per workspace |
| Empty query + Shift+Enter | A) Do nothing<br>B) Prompt for filename | A) Do nothing | Consistent with "query becomes filename" behavior |
| Footer instruction display | A) Always show (dynamic)<br>B) Only with query<br>C) Hide for empty | A) Always show | Provides consistent guidance, updates based on context |
| Footer wording | A) "shift ↵ to create" / "↵ to open"<br>B) Verbose versions<br>C) Ultra compact | A) Current wording | Clear, concise, matches Obsidian conventions |

## Open Questions

None - All design decisions finalized and confirmed by user.

## Context to Continue

### Current Status
- **Phase**: Implementation ready
- **Tests passing**: 105 tests
- **Last build**: Green (type-check + test + build all passing)
- **Plugin mode**: Feature-complete, maintenance mode → adding new feature

### What Was Planned

**Feature**: Modifier key support matching Obsidian's original Quick Switcher
- **Shift+Enter**: Create new note with query text as filename (only if no selection exists)
- **Footer hints**: Dynamic instructions that update based on modal state
  - Empty query / has matches: "↵ to open"
  - Has query but no matches: "shift ↵ to create"
- **New note behavior**: 
  - Respect Obsidian's "Default location for new notes" setting
  - Optional global template setting for frontmatter insertion
  - Handle duplicates by opening existing file
  - Sanitize invalid filename characters

**Architecture Decision**: Follow pure functions pattern
- Extract modifier key logic → `src/utils/modifierKeyUtils.ts`
- Write comprehensive tests first (~18 tests)
- Keep modal thin (data extraction + UI integration)

### Files Identified for Changes

**NEW Files**:
1. `src/utils/modifierKeyUtils.ts` - Pure logic for modifier key interpretation
2. `src/utils/modifierKeyUtils.test.ts` - 18 comprehensive tests

**MODIFY Files**:
1. `src/types.ts` - Add `ModifierAction` enum + `newNoteTemplate` setting
2. `src/SmartQuickSwitcherModal.ts` - Add footer, modifier handling, note creation
3. `src/SettingsTab.ts` - Add template picker UI (optional)

### Research Findings

**Obsidian API Methods Discovered**:
- `setInstructions([{ command, purpose }])` - Add footer hints to modal
- `Keymap.isModifier(evt, 'Shift')` - Check modifier keys
- Direct access: `evt.shiftKey`, `evt.metaKey`, `evt.ctrlKey`, `evt.altKey`
- `app.vault.create(path, content)` - Create new note
- `app.fileManager.getNewFileParent(currentPath)` - Get default folder (respects user settings)
- `normalizePath()` - Sanitize paths
- `app.vault.getAbstractFileByPath(path)` - Check if file exists

**Pattern Found**: Other plugins use similar approach for modifier keys

### Next Immediate Steps

1. Create `src/utils/modifierKeyUtils.ts` with pure functions
2. Create `src/utils/modifierKeyUtils.test.ts` with 18 tests
3. Run `npm test -- modifierKeyUtils` to verify
4. Update `src/types.ts` with enum and settings
5. Modify `src/SmartQuickSwitcherModal.ts` with all changes
6. Add template picker to `src/SettingsTab.ts`
7. Run full CI: `npm run type-check && npm test && npm run build`
8. Manual testing in Obsidian

## Detailed Plan (CRITICAL)

### Feature: Modifier Key Support with Dynamic Footer Hints

**Status**: PLANNED (implementation about to start)

---

#### **STEP 1: Create Pure Utility Functions** ✅ READY

**File**: `src/utils/modifierKeyUtils.ts`

**Exports**:
```typescript
export enum ModifierAction {
  OPEN_NORMAL = 'open-normal',
  CREATE_NOTE = 'create-note',
  OPEN_NEW_PANE = 'open-new-pane',      // Future
  OPEN_NEW_WINDOW = 'open-new-window'   // Future
}

export interface ModifierKeyConfig {
  shiftKey: boolean;
  ctrlKey: boolean;
  metaKey: boolean;
  altKey: boolean;
}

// Main logic: determine action from modifiers + selection state
export function getModifierAction(
  modifiers: ModifierKeyConfig,
  hasSelection: boolean
): ModifierAction

// Helper: extract modifiers from event
export function extractModifiers(
  evt: KeyboardEvent | MouseEvent
): ModifierKeyConfig
```

**Logic**:
- Shift+Enter with NO selection → CREATE_NOTE
- Shift+Enter with selection → OPEN_NORMAL (ignore shift, open selected file)
- Enter (no modifiers) → OPEN_NORMAL
- Other modifiers → OPEN_NORMAL (reserved for future)

**Acceptance**:
- Pure functions (no Obsidian API)
- All inputs/outputs typed
- ~50 lines of code

---

#### **STEP 2: Write Comprehensive Tests** ✅ READY

**File**: `src/utils/modifierKeyUtils.test.ts`

**Test Groups** (18 tests total):

1. **Shift key with NO selection** (2 tests)
   - Returns CREATE_NOTE when shift pressed and no selection
   - Returns CREATE_NOTE when only shift pressed (no other modifiers)

2. **Shift key WITH selection** (1 test)
   - Returns OPEN_NORMAL when shift pressed WITH selection (ignores shift)

3. **No modifier behavior** (2 tests)
   - Returns OPEN_NORMAL when no modifiers and has selection
   - Returns OPEN_NORMAL when no modifiers and no selection

4. **Future modifiers** (2 tests)
   - Returns OPEN_NORMAL for Cmd+Enter with selection
   - Returns OPEN_NORMAL for Ctrl+Enter with selection

5. **Edge cases** (4 tests)
   - Handles all modifiers false with no selection
   - Prioritizes "has selection" over shift key
   - Shift+Ctrl with no selection returns OPEN_NORMAL (ctrl disables shift)
   - Shift+Cmd with selection returns OPEN_NORMAL

6. **extractModifiers()** (3 tests)
   - Extracts all modifier keys from KeyboardEvent
   - Extracts all modifier keys from MouseEvent
   - Returns all false for event with no modifiers

7. **Integration** (4 tests)
   - Complete flow: no modifiers + selection → open
   - Complete flow: shift + no selection → create
   - Complete flow: shift + selection → open (ignore shift)
   - Complete flow: empty modifiers + no selection → open

**Acceptance**:
- All 18 tests pass
- Coverage: 100% of modifierKeyUtils.ts
- Run: `npm test -- modifierKeyUtils`

---

#### **STEP 3: Update Type Definitions** ✅ READY

**File**: `src/types.ts`

**Changes**:

1. Add enum (after imports):
```typescript
export enum ModifierAction {
  OPEN_NORMAL = 'open-normal',
  CREATE_NOTE = 'create-note',
  OPEN_NEW_PANE = 'open-new-pane',
  OPEN_NEW_WINDOW = 'open-new-window'
}
```

2. Add field to `SmartQuickSwitcherSettings` interface:
```typescript
export interface SmartQuickSwitcherSettings {
  rules: SearchRule[];
  workspaceRules: Record<string, string[]>;
  maxSuggestions: number;
  showDirectory: boolean;
  maxRecentFiles: number;
  newNoteTemplate?: string;  // NEW: Optional path to template file
}
```

3. Update `DEFAULT_SETTINGS`:
```typescript
export const DEFAULT_SETTINGS: SmartQuickSwitcherSettings = {
  rules: [],
  workspaceRules: {},
  maxSuggestions: 50,
  showDirectory: true,
  maxRecentFiles: 4,
  newNoteTemplate: undefined,  // NEW
};
```

**Acceptance**:
- TypeScript compiles: `npm run type-check`
- No breaking changes to existing code

---

#### **STEP 4: Modify Modal for Modifier Keys** ✅ READY

**File**: `src/SmartQuickSwitcherModal.ts`

**Changes**:

**A. Add imports** (top of file):
```typescript
import { normalizePath, TFile } from 'obsidian';
import { getModifierAction, extractModifiers, ModifierAction } from './utils/modifierKeyUtils';
```

**B. Add property** (line ~18, after existing properties):
```typescript
private currentSuggestions: FuzzyMatch<TFile>[] = [];
```

**C. Add footer update in constructor** (line ~43, after `setPlaceholder()`):
```typescript
// Initialize with default footer
this.setInstructions([
  { command: "↵", purpose: "to open" }
]);
```

**D. Update `getSuggestions()` method** (line ~66, at end before return):
```typescript
getSuggestions(query: string): FuzzyMatch<TFile>[] {
  this.lastQuery = query;
  
  // ... existing suggestion logic ...
  
  // Store current suggestions and update footer
  this.currentSuggestions = finalSuggestions;  // NEW
  this.updateInstructions(
    finalSuggestions.length > 0, 
    query.length > 0
  );  // NEW
  
  return finalSuggestions;
}
```

**E. Add new method** `updateInstructions()` (after `getSuggestions()`):
```typescript
/**
 * Update footer instructions based on current state
 */
private updateInstructions(hasMatches: boolean, hasQuery: boolean): void {
  if (!hasQuery) {
    // Empty query: show open hint
    this.setInstructions([
      { command: "↵", purpose: "to open" }
    ]);
  } else if (hasMatches) {
    // Has matches: show open hint only
    this.setInstructions([
      { command: "↵", purpose: "to open" }
    ]);
  } else {
    // No matches: show create hint only
    this.setInstructions([
      { command: "shift ↵", purpose: "to create" }
    ]);
  }
}
```

**F. Replace `onChooseItem()` method** (line ~154):
```typescript
async onChooseItem(file: TFile | null, evt: MouseEvent | KeyboardEvent): Promise<void> {
  const modifiers = extractModifiers(evt);
  const hasSelection = file !== null;
  const action = getModifierAction(modifiers, hasSelection);
  
  switch (action) {
    case ModifierAction.CREATE_NOTE:
      // Only reached if no selection and shift pressed
      if (!this.lastQuery || this.lastQuery.trim().length === 0) {
        // Empty query: do nothing
        return;
      }
      await this.createNewNote(this.lastQuery);
      break;
      
    case ModifierAction.OPEN_NORMAL:
    default:
      if (file) {
        this.app.workspace.getLeaf().openFile(file);
      }
      // If no file and no shift: do nothing
      break;
  }
}
```

**G. Add new method** `createNewNote()` (after `onChooseItem()`):
```typescript
/**
 * Create a new note with the given filename
 * Respects Obsidian's "Default location for new notes" setting
 * Handles duplicate filenames by opening existing file
 */
private async createNewNote(fileName: string): Promise<void> {
  // Sanitize filename (remove invalid characters)
  const sanitized = fileName.replace(/[\\/:*?"<>|]/g, '');
  if (!sanitized || sanitized.trim().length === 0) {
    return; // Don't create note with empty name
  }
  
  // Get default folder (respects user's Obsidian settings)
  const currentFile = this.app.workspace.getActiveFile();
  const folder = this.app.fileManager.getNewFileParent(
    currentFile?.path || ""
  );
  
  // Construct path
  const path = normalizePath(`${folder.path}/${sanitized}.md`);
  
  // Check if file already exists
  const existingFile = this.app.vault.getAbstractFileByPath(path);
  if (existingFile && existingFile instanceof TFile) {
    // Open existing file instead of creating duplicate
    await this.app.workspace.getLeaf().openFile(existingFile);
    return;
  }
  
  // Get template content (if configured)
  const content = await this.getTemplateContent();
  
  // Create the file
  const newFile = await this.app.vault.create(path, content);
  
  // Open the new file
  await this.app.workspace.getLeaf().openFile(newFile);
}
```

**H. Add new method** `getTemplateContent()` (after `createNewNote()`):
```typescript
/**
 * Get template content for new notes (if template configured)
 * Returns empty string if no template set
 */
private async getTemplateContent(): Promise<string> {
  // Access plugin settings via app
  const plugin = (this.app as any).plugins?.plugins['obsidian-smart-quick-switcher'];
  const templatePath = plugin?.settings?.newNoteTemplate;
  
  if (!templatePath) {
    return '';  // No template configured
  }
  
  const templateFile = this.app.vault.getAbstractFileByPath(templatePath);
  if (!templateFile || !(templateFile instanceof TFile)) {
    console.warn('[SmartQuickSwitcher] Template not found:', templatePath);
    return '';  // Template file not found
  }
  
  try {
    const content = await this.app.vault.read(templateFile);
    return content;
  } catch (error) {
    console.error('[SmartQuickSwitcher] Failed to read template:', error);
    return '';
  }
}
```

**Acceptance**:
- TypeScript compiles
- No breaking changes to existing search behavior
- Footer updates dynamically during typing
- Shift+Enter creates notes when no match

---

#### **STEP 5: Add Template Picker to Settings** ✅ READY

**File**: `src/SettingsTab.ts`

**Changes**:

**A. Add import** (top of file):
```typescript
import { FuzzySuggestModal } from 'obsidian';
```

**B. Add setting** (in `display()` method, after existing settings ~line 100-150):
```typescript
// Template for new notes
new Setting(containerEl)
  .setName('New note template')
  .setDesc('Optional: Select a template file to use when creating notes with Shift+Enter')
  .addButton(button => {
    button
      .setButtonText(this.plugin.settings.newNoteTemplate || 'No template')
      .onClick(async () => {
        const modal = new TemplateSuggestModal(
          this.app,
          async (file: TFile) => {
            this.plugin.settings.newNoteTemplate = file.path;
            await this.plugin.saveSettings();
            button.setButtonText(file.path);
          }
        );
        modal.open();
      });
  })
  .addButton(button => {
    button
      .setButtonText('Clear')
      .setDisabled(!this.plugin.settings.newNoteTemplate)
      .onClick(async () => {
        this.plugin.settings.newNoteTemplate = undefined;
        await this.plugin.saveSettings();
        // Update first button text
        const firstButton = button.buttonEl.parentElement?.querySelector('button');
        if (firstButton) {
          firstButton.textContent = 'No template';
        }
      });
  });
```

**C. Add modal class** (at bottom of file, after `SmartQuickSwitcherSettingTab` class):
```typescript
/**
 * Modal for selecting a template file
 */
class TemplateSuggestModal extends FuzzySuggestModal<TFile> {
  private onChooseCallback: (file: TFile) => Promise<void>;

  constructor(app: App, onChoose: (file: TFile) => Promise<void>) {
    super(app);
    this.onChooseCallback = onChoose;
    this.setPlaceholder('Select template file...');
  }

  getItems(): TFile[] {
    return this.app.vault.getMarkdownFiles();
  }

  getItemText(file: TFile): string {
    return file.path;
  }

  async onChooseItem(file: TFile): Promise<void> {
    await this.onChooseCallback(file);
  }
}
```

**Acceptance**:
- Settings UI displays template picker
- Can select template from vault
- Can clear template setting
- Settings persist across reload

---

#### **STEP 6: Verification & Testing** ✅ READY

**A. Run Full CI**:
```bash
npm run type-check && npm test && npm run build
```

**Expected**:
- Type check: PASS
- Tests: 123 passing (105 + 18 new)
- Build: SUCCESS

**B. Manual Testing Checklist**:

1. **Empty Query**:
   - [ ] Footer shows "↵ to open"
   - [ ] Enter opens selected file
   - [ ] Shift+Enter opens selected file (ignores shift)

2. **Query with Matches**:
   - [ ] Footer shows "↵ to open"
   - [ ] Enter opens selected file
   - [ ] Shift+Enter opens selected file (ignores shift)

3. **Query with NO Matches**:
   - [ ] Footer shows "shift ↵ to create"
   - [ ] Enter does nothing
   - [ ] Shift+Enter creates new note with query as filename

4. **Special Characters in Query**:
   - [ ] Query "test/note:2?" creates "testnote2.md"
   - [ ] Invalid chars sanitized

5. **Duplicate Filename**:
   - [ ] Shift+Enter on existing filename opens existing file
   - [ ] No duplicate created

6. **Template Setting**:
   - [ ] Can select template in settings
   - [ ] New notes use template content
   - [ ] Can clear template
   - [ ] New notes without template are blank

7. **Default Location**:
   - [ ] New notes respect Obsidian's "Default location for new notes" setting
   - [ ] Test with "Root folder" setting
   - [ ] Test with "Same folder as current file" setting
   - [ ] Test with specific folder setting

**C. Edge Cases**:
- [ ] Empty query + Shift+Enter → nothing happens
- [ ] Very long query (>100 chars) → creates note normally
- [ ] Query with only spaces → sanitized to empty, no note created
- [ ] Template file deleted → creates blank note, logs warning

---

#### **Summary of Changes**

**New Files** (2):
- `src/utils/modifierKeyUtils.ts` (~60 lines)
- `src/utils/modifierKeyUtils.test.ts` (~250 lines, 18 tests)

**Modified Files** (3):
- `src/types.ts` (+10 lines)
- `src/SmartQuickSwitcherModal.ts` (+120 lines)
- `src/SettingsTab.ts` (+50 lines)

**Total LOC**: ~490 new lines

**Test Count**: 105 → 123 tests (+18)

**Estimated Time**: 2.5 hours

**Risk**: Low (isolated changes, pure functions pattern, comprehensive tests)

---

#### **Implementation Order**

1. ✅ Create modifierKeyUtils.ts
2. ✅ Create modifierKeyUtils.test.ts
3. ✅ Run tests: `npm test -- modifierKeyUtils`
4. ✅ Update types.ts
5. ✅ Modify SmartQuickSwitcherModal.ts
6. ✅ Modify SettingsTab.ts
7. ✅ Run full CI
8. ✅ Manual testing in Obsidian
9. ✅ Document in knowledge base

---

#### **Acceptance Criteria**

**Functional**:
- [ ] Shift+Enter creates new note when no match found
- [ ] Shift+Enter opens selected file when match exists
- [ ] Footer updates dynamically based on modal state
- [ ] New notes respect Obsidian default location setting
- [ ] Template setting works (optional)
- [ ] Duplicate filenames handled gracefully
- [ ] Invalid filename characters sanitized

**Technical**:
- [ ] All 123 tests pass
- [ ] Type check passes
- [ ] Build succeeds
- [ ] No regression in existing search functionality
- [ ] Pure functions pattern maintained

**Documentation**:
- [ ] Session saved to knowledge base
- [ ] PLAN.md updated with new feature
- [ ] Domain knowledge updated if needed

---

**Status**: READY TO IMPLEMENT
**Next Action**: Create `src/utils/modifierKeyUtils.ts`
